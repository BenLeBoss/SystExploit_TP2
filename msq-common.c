#include <stdio.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <string.h>

#include "msq-common.h"
#include "msq-message.h"


/*d√©finition des sous-programmes communs*/


int link_to_memory(const char *pathname, int proj_id, char *user){
  int msqId;
  key_t key = ftok(pathname, proj_id);
  if(key == -1){
    fprintf(stderr, "./msq-%s.out:%s:%d: Unable to create the System V IPC key from the \"%s\"pathname and the \"%d\" project identifier.\n", user, __FILE__, __LINE__, pathname, proj_id);
    return -1;
  }
  if(!strcmp(user, "server")){
    msqId = msgget(key, IPC_EXCL | IPC_CREAT | 0600);
  }else if(!strcmp(user, "client")){
    msqId = msgget(key, 0);
  }else{
    fprintf(stderr, "Goulag pour ta famille %s", user);
  }
  if(msqId == -1){
    fprintf(stderr, "./msq-%s.out:%s:%d: Unable to get the identifier of the System V message queue from the \"0x%08x\" key.\n", user, __FILE__, __LINE__, key);
    return -1;
  }
  return msqId;
}
