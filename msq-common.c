#include <stdio.h>
#include <sys/ipc.h>
#include <sys/msq.h>
#include <string.h>

#include "msq-common.h"
#include "msq-message.h"


/*d√©finition des sous-programmes communs*/


int link_to_memory(const char *pathname, int proj_id, char *user){
  int msqId;
  key_t key = ftok(pathname, proj_id);
  if(key == -1){
    fprintf(stderr, "./msq-%s.out:msq-common.c:15: Unable to create the System V IPC key from the \"%s\"pathname and the \"%d\" project identifier.\n", user, pathname, proj_id);
    return -1;
  }
  if(!strcmp(user, "server")){
    msqId = msqget(key, sizeof(msq_message_t), IPC_EXCL | IPC_CREAT | 0600);
  }else if(!strcmp(user, "client")){
    msqId = msqget(key, sizeof(msq_message_t), 0);
  }else{
    fprintf(stderr, "Goulag pour ta famille %s", user);
  }
  if(msqId == -1){
    fprintf(stderr, "./msq-%s.out:msq-common.c:20: Unable to get the identifier of the System V shared memorysegment from the \"0x%08x\" key.\n", user, key);
    return -1;
  }
  return msqId;
}
